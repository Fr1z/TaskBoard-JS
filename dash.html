<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Table with JSON Data</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        th {
            cursor: pointer;
        }

        /* Highlight row when dragging */
        .dragging {
            background-color: #f0f0f0;
            opacity: 0.6;
        }

        /* Style for the row placeholder (where the row would be dropped) */
        .placeholder {
            border: 2px dashed #007bff;
            height: 50px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h3 class="mb-4">Sortable, Editable Table with Drag & Drop</h3>

        <!-- Table -->
        <table class="table table-striped" id="dataTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Name</th>
                    <th onclick="sortTable(1)">Age</th>
                    <th onclick="sortTable(2)">Email</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Bootstrap JS + Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript to Load JSON and Populate Table -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch the JSON data
            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#dataTable tbody');
                    let rows = '';

                    // Loop through the JSON data and create rows
                    data.forEach((item) => {
                        rows += `
                            <tr draggable="true">
                                <td>${item.name}</td>
                                <td>${item.age}</td>
                                <td contenteditable="true">${item.email}</td>
                            </tr>
                        `;
                    });

                    // Insert rows into the table body
                    tableBody.innerHTML = rows;
                }).then(enableDragAndDrop())
                .catch(error => console.error('Error loading JSON:', error));

            //Enable Drag&Drop

        });

        // Sort table function
        function sortTable(columnIndex) {
            const table = document.getElementById("dataTable");
            const rowsArray = Array.from(table.rows).slice(1); // Skip the header row
            const isAscending = table.getAttribute('data-sort-asc') === 'true';

            // Sort rows based on the selected column
            rowsArray.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].textContent.trim();
                const cellB = rowB.cells[columnIndex].textContent.trim();

                if (!isNaN(cellA) && !isNaN(cellB)) {
                    // Sort numbers
                    return isAscending ? cellA - cellB : cellB - cellA;
                }

                // Sort strings
                return isAscending
                    ? cellA.localeCompare(cellB)
                    : cellB.localeCompare(cellA);
            });

            // Append sorted rows to the table body
            rowsArray.forEach(row => table.tBodies[0].appendChild(row));

            // Toggle sort order
            table.setAttribute('data-sort-asc', !isAscending);
        }

        //
        // DRAG & DROP JS
        //
        // Enable drag and drop functionality for rows
        function enableDragAndDrop() {
            const rows = document.querySelectorAll('#dataTable tbody tr');

            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });

            console.log("D&D Enabled");
        }

        let draggedRow = null;
        let placeholder = null;
        
        // Handle the drag start event
        function handleDragStart(event) {
            draggedRow = event.target; // Store reference to the dragged row
            event.target.classList.add('dragging'); // Add visual feedback

            console.log('handlestart');
            // Create a placeholder for visual feedback
            placeholder = document.createElement('tr');
            placeholder.classList.add('placeholder');
            placeholder.innerHTML = `<td colspan="3"></td>`;
        }

        // Handle drag over event (needed to allow dropping)
        function handleDragOver(event) {
            event.preventDefault(); // Prevent the default behavior to allow dropping
            const targetRow = event.target.closest('tr');
            const tbody = document.querySelector('#dataTable tbody');

            if (targetRow && targetRow !== draggedRow && targetRow !== placeholder) {
                const rect = targetRow.getBoundingClientRect();
                const offset = event.clientY - rect.top;

                // If dragging down, insert placeholder below the target row
                if (offset > rect.height / 2) {
                    tbody.insertBefore(placeholder, targetRow.nextSibling);
                } else {
                    // Insert placeholder above the target row
                    tbody.insertBefore(placeholder, targetRow);
                }
            }
        }

        // Handle drop event (triggered when a row is dropped)
        function handleDrop(event) {
            event.preventDefault(); // Prevent default drop behavior
            const tbody = document.querySelector('#dataTable tbody');

            // Move the dragged row to the position of the placeholder
            if (placeholder && draggedRow) {
                tbody.insertBefore(draggedRow, placeholder);
            }
        }

        // Handle drag end (remove visual feedback)
        function handleDragEnd(event) {
            event.target.classList.remove('dragging'); // Remove visual feedback

            // Remove the placeholder
            if (placeholder) {
                placeholder.remove();
                placeholder = null;
            }

            draggedRow = null; // Clear the reference to the dragged row
        }
    </script>
</body>

</html>